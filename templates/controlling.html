<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT RC Car Controlling Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha512-dy9e6h8RL9O/i6UAB8vTMpqwe9YcJh+qR5Wcwdi73QOxt30GxG9wE0qZ6xzt06FbFQFwz6YNLnE+bi3IJ6ubxg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>

    </style>
</head>
<body>

    <!-- Sidebar and Content -->
    <div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    {% include 'sidebar.html' %}

        <!-- Content -->
        <div id="page-content-wrapper" class="w-100" style="margin-left: 350px;">
            <div class="container-fluid mt-4">
                <div class="d-flex justify-content-between mt-4">
                    <h1>Dashboard - Controlling</h1>
                    <button id="darkModeToggle" class="btn btn-secondary p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon-size">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
                        </svg>
                    </button>
                </div>
                

                    <!-- Status Section -->
                    <div class="status-box mt-4">
                        <div>
                            <h5>Battery</h5>
                            <div id="battery-status">
                                <svg id="battery-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 10.5h.375c.621 0 1.125.504 1.125 1.125v2.25c0 .621-.504 1.125-1.125 1.125H21M3.75 18h15A2.25 2.25 0 0 0 21 15.75v-6a2.25 2.25 0 0 0-2.25-2.25h-15A2.25 2.25 0 0 0 1.5 9.75v6A2.25 2.25 0 0 0 3.75 18Z" />
                                </svg>
                                <span id="battery-percentage">Loading...</span>
                            </div>
                        </div>
                        <div>
                            <h5>Signal</h5>
                            <div id="signal-status">
                                <svg id="signal-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 0 0-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                                </svg>
                                <span id="signal-strength">Loading...</span>
                            </div>
                        </div>
                    </div>  

                <!-- Controlling Section -->
                <div class="controlling" id="controlling" class="mt-5">
                    <p>Use the following keys to control the car or click the buttons below:</p>

                    <!-- Camera Feed Section -->
                    <div class="camera-feed-container">
                        <div id="camera-section">
                            <img id="camera-feed" src="/camera-feed" alt="Live Camera Feed" class="img-fluid rounded shadow-sm mirror">
                            <p id="camera-error-message" style="display: none;">Camera Not Found</p>
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <div class="d-flex justify-content-center">
                        <div>
                            <button class="btn btn-primary control-btn" onclick="sendControl('W')">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" />
                                </svg>                                  
                            </button>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button class="btn btn-primary control-btn" onclick="sendControl('A')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                            </svg>                              
                        </button>
                        <button class="btn btn-primary control-btn" onclick="sendControl('S')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3" />
                            </svg>
                        </button>                        
                        <button class="btn btn-primary control-btn" onclick="sendControl('D')">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
                            </svg>                              
                        </button>
                    </div>
                    <button class="btn btn-primary control-btn" id="stopButton" onclick="sendControl('X')" style="display:none;">
                        Stop
                    </button>
                    
                                     
                </div>
            </div>
        </div>
    </div>

    <!-- Font Awesome for icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <!-- JS and scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    

    <script>
        // Function to send control commands
        function sendControl(direction) {
            fetch(`/control-car?direction=${direction}`)
                .then(response => response.json());
                // .then(data => alert(`Command ${direction} sent successfully`))
                // .catch(error => alert('Error sending command!'));
        }


        // Menangani efek visual ketika tombol ditekan
        document.addEventListener('keydown', function(event) {
            const key = event.key.toUpperCase();
            const button = document.querySelector(`button[onclick="sendControl('${key}')"]`);
            if (button) {
                button.classList.add('pressed'); // Tambahkan kelas pressed
                sendControl(key); // Kirim kontrol
            }
        });

        document.addEventListener('keyup', function(event) {
            const key = event.key.toUpperCase();
            const button = document.querySelector(`button[onclick="sendControl('${key}')"]`);
            if (button) {
                button.classList.remove('pressed'); // Hapus kelas pressed
            }

            // Tambahkan logika untuk Stop (X) ketika W, S, A, atau D dilepaskan
            if (key === 'W' || key === 'S' || key === 'A' || key === 'D') {
                sendControl('X'); // Kirim perintah Stop
            }
        });




        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
            const darkModeIcon = document.getElementById('darkModeIcon');

            // Check if body already has dark mode on page load
            if (document.body.classList.contains('dark-mode')) {
                darkModeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                `;
            }

            darkModeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');

                // Toggle the icon when dark mode is activated/deactivated
                if (document.body.classList.contains('dark-mode')) {
                    // Change to Sun Icon (Dark Mode)
                    darkModeIcon.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                    `;
                } else {
                    // Change to Moon Icon (Light Mode)
                    darkModeIcon.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
                    `;
                }
            });

        // Fetch battery and signal status
        // Fetch the sensor data and update the UI
        function updateSensorData() {
            $.get("/sensor-data", function(data) {
                // Update Battery Status
                updateBatteryStatus(data.battery);
                // Update Signal Status
                updateSignalStrength(data.signal);
            });
        }

        // Update battery status dynamically
        function updateBatteryStatus(batteryLevel) {
            const batteryIcon = document.getElementById("battery-icon");
            const batteryPercentage = document.getElementById("battery-percentage");

            batteryPercentage.textContent = `${batteryLevel}%`;

            if (batteryLevel > 60) {
                batteryIcon.style.fill = "green";
            } else if (batteryLevel > 30) {
                batteryIcon.style.fill = "yellow";
            } else {
                batteryIcon.style.fill = "red";
            }
        }


        // Update signal status dynamically
        function updateSignalStrength(signalLevel) {
            const signalIcon = document.getElementById("signal-icon");
            const signalText = document.getElementById("signal-strength");

            signalText.textContent = `${signalLevel}%`;

            if (signalLevel > 75) {
                signalIcon.style.fill = "green";
            } else if (signalLevel > 50) {
                signalIcon.style.fill = "yellow";
            } else {
                signalIcon.style.fill = "red";
            }
        }


        // Call the function to update data on page load
        $(document).ready(function() {
            updateSensorData(); // Update battery and signal on page load
        });
        
    </script>
</body>
</html>
